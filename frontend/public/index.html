<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Saveforest.ai</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <link rel="stylesheet" href="/styles/style.css">
  </head>
  <body>
    <div class="container-fluid text-center rounded-4 px-4 py-4" style="height: 98vh;">
        <!-- Navbar -->
        <div class="row" style="background-image: linear-gradient(to right, #3D3D3D, #2b2b2b);">
            <div class="col"><i class="bi bi bi-tree" style="font-size: 1.7vw;color: rgb(255, 255, 255);"></i></div>
            <div class="col-9 fs-3" style="text-align: start;"><span>Saveforest.ai</span></div>
            <div class="col"><i class="bi bi bi-laptop" onclick="onDashIconClick()" style="font-size: 1.7vw;color: rgb(255, 255, 255);"></i></div>
            <div class="col"><i class="bi bi bi-geo-alt" onclick="onLocIconClick()" style="font-size: 1.7vw;color: rgb(255, 255, 255);"></i></div>
            <div class="col"><i class="bi bi bi-gear" style="font-size: 1.7vw;color: rgb(255, 255, 255);"></i></div>
        </div>
        <!-- Content -->
        <div class="row" id="content"></div>
    </div>
      
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" 
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="/scripts/leaflet.rotatedMarker.js"></script>
  </body>
  
    <script>
        function createContentLayout(name){
            const content = document.getElementById("content");
            switch(name){
                case "dash":
                    content.innerHTML =
                    `
                    <div class="col-5 m-3" id="sensor-monitors" style="height: 86vh;"></div>
                    <div class="col m-3" style="height: 86vh;">
                        <div class="row" style="height: 60vh; background-color: #1D1C1C;"><div id="map"></div></div>
                        <div class="row my-3" id="monitor-container" style="height: 24vh;"></div>
                    </div>
                    `;
                    break;
                case "loc":
                    content.innerHTML =
                    `
                    <div class="col m-3" style="height: 86vh;">
                        <div class="row" style="height: 60vh;">
                            <div class="col me-3" style="height: 86vh; background-color: #1D1C1C;"> 
                                <div id="map-l"></div>
                            </div>
                            <div class="col-5 ">
                                <div class="row mb-3" id="monitor-container-1" style="height: 24vh;"></div>
                                <div class="row mb-3" id="monitor-container-2" style="height: 24vh;"></div>
                            </div>
                        </div>
                    </div>
                    `;
                    break;
            }
        }

        function createStatusMonitor(id, data){
            const monitor = document.getElementById(id);
            const val_id = data.name.replace(/\s/g, "").toLowerCase();
            monitor.innerHTML += 
            `
            <div class="col me-2" style="background-color: #1D1C1C;">
                <div class="m-1 mt-3" style="background-image: linear-gradient(to right, rgb(211, 211, 5), yellow); height: 3vh;"></div>
                <div id="${val_id}_value" style="font-size: 3vw; padding-top: 2vh; height: 13vh;">${data.value}</div>
                <div style="font-size: 1.2vw; padding-top: 0.5vh; height: 4vh;">${data.name}</div>
            </div>
            `;
            return val_id;
        }

        function createStatusMonitorImage(id, data){
            const monitor = document.getElementById(id);
            const val_id = data.name.replace(/\s/g, "").toLowerCase();
            monitor.innerHTML += 
            `
            <div class="col me-2" style="background-color: #1D1C1C;">
                <canvas id="${val_id}" width=140 height=140 style="background-color: greenyellow; margin-top:10px"></canvas>
                <div style="font-size: 1.2vw; padding-top: 0.5vh; height: 4vh;">${data.name}</div>
            </div>
            `;
            return val_id;
        }


        function createSensorMonitor(id, graph_id){
            const monitor = document.getElementById(id);
            monitor.innerHTML +=
            `
            <div class="row bg-dash-graph mb-3" style="height: 42vh;">
                <div class="col-9 m-2" style="height: 40vh;"><canvas class="graph" id="${graph_id}" style="height: 40vh; width: 30vw;"></canvas></div>
                <div class="col py-2 m-1" style="height: 40vh;">
                    <div class="row">
                        <div class="col-2"><i class="bi bi bi-circle-fill" style="font-size: 1.2vw;color: red;"></i></div>
                        <div class="col-3" style="text-align: start; color: red;"><span style="font-size: 1.2vw;">CO</span><br><span style="position: relative; top: -5px; font-size: 0.8vw;">CJMCU</span></div>
                        <div class="col" id="graph1_val1" style="text-align: center; font-size: 1.1vw;">2.98</div>
                    </div>
                    <div class="row">
                        <div class="col-2"><i class="bi bi bi-circle-fill" style="font-size: 1.2vw;color: aqua;"></i></div>
                        <div class="col-3" style="text-align: start; color: aqua;"><span style="font-size: 1.2vw;">CO</span><br><span style="position: relative; top: -5px; font-size: 0.8vw;">TGS2600</span></div>
                        <div class="col" id="graph1_val2" style="text-align: center; font-size: 1.1vw;">0.78</div>
                    </div>
                    <div class="row">
                        <div class="col-2"><i class="bi bi bi-circle-fill" style="font-size: 1.2vw;color: greenyellow;"></i></div>
                        <div class="col-3" style="text-align: start; color: greenyellow;"><span style="font-size: 1.2vw;">CH4</span><br><span style="position: relative; top: -5px; font-size: 0.8vw;">TGS2600</span></div>
                        <div class="col" id="graph1_val3" style="text-align: center; font-size: 1.1vw;">0.5</div>
                    </div>
                </div>
            </div>
            `
        }

        function createSensorMonitor2(id, graph_id){
            const monitor = document.getElementById(id);
            monitor.innerHTML +=
            `
            <div class="row bg-dash-graph mb-3" style="height: 42vh;">
                <div class="col-9 m-2" style="height: 40vh;"><canvas class="graph" id="${graph_id}" style="height: 40vh; width: 30vw;"></canvas></div>
                <div class="col py-2 m-1" style="height: 40vh;">
                    <div class="row">
                        <div class="col-2"><i class="bi bi bi-circle-fill" style="font-size: 1.2vw;color: red;"></i></div>
                        <div class="col-3" style="text-align: start; color: red;"><span style="font-size: 1.2vw;">H2S</span><br><span style="position: relative; top: -5px; font-size: 0.8vw;">TGS2602</span></div>
                        <div class="col" id="graph2_val1" style="text-align: center; font-size: 1.1vw;">0.56</div>
                    </div>
                    <div class="row">
                        <div class="col-2"><i class="bi bi bi-circle-fill" style="font-size: 1.2vw;color: aqua;"></i></div>
                        <div class="col-3" style="text-align: start; color: aqua;"><span style="font-size: 1.2vw;">VOC</span><br><span style="position: relative; top: -5px; font-size: 0.8vw;">TGS2602</span></div>
                        <div class="col" id="graph2_val2" style="text-align: center; font-size: 1.1vw;">0.53</div>
                    </div>
                </div>
            </div>
            `
        }

        function createSensorGraph(id, label) {
            const ctx = document.getElementById(id);
            const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['12:30:20', '12:30:22', '12:30:24', '12:30:26', '12:30:28', '12:30:30', '12:30:33'],
                datasets:[{
                    label: 'label',
                    data: [2.8, 2.7, 2.65, 2.94, 2.98, 2.96, 2.98],
                    fill: false,
                    tension: 0.3,
                    backgroundColor: '#FF4301',
                    borderColor: '#FF4301',
                    color: '#444444',
                    // fontColor:'#FFFFFF',
                },
                {
                    label: label,
                    data: [0.78, 0.76, 0.75, 0.78, 0.78, 0.78, 0.78],
                    fill: false,
                    tension: 0.3,
                    backgroundColor: 'aqua',
                    borderColor: 'aqua',
                    color: '#444444',
                    // fontColor:'#FFFFFF',
                },
                {
                    label: label,
                    data: [0.5, 0.5, 0.54, 0.45, 0.5, 0.5, 0.5],
                    fill: false,
                    tension: 0.3,
                    backgroundColor: 'greenyellow',
                    borderColor: 'greenyellow',
                    color: '#444444',
                    // fontColor:'#FFFFFF',
                }]
            },
            options: {
                responsive:false,
                // animation: false,
                scaleFontColor: '#FFFFFF',
                spanGaps:true,
                scales:{
                    x:{
                        grid: {
                            color:'#444444',
                        }
                    },
                    y:{
                        grid: {
                            color:'#444444',
                        }
                    }
                },
                plugins:{
                    legend:{
                        display:false,
                    }
                }
            }
            });

            return chart;
        }

        function createSensorGraph2(id, label) {
            const ctx = document.getElementById(id);
            const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['12:30:20', '12:30:22', '12:30:24', '12:30:26', '12:30:28', '12:30:30', '12:30:33'],
                datasets:[{
                    label: 'label',
                    data: [0.53, 0.51, 0.52, 0.53, 0.52, 0.52, 0.53],
                    fill: false,
                    tension: 0.3,
                    backgroundColor: '#FF4301',
                    borderColor: '#FF4301',
                    color: '#444444',
                    // fontColor:'#FFFFFF',
                },
                {
                    label: label,
                    data: [0.54, 0.54, 0.56, 0.54, 0.56, 0.56, 0.56],
                    fill: false,
                    tension: 0.3,
                    backgroundColor: 'aqua',
                    borderColor: 'aqua',
                    color: '#444444',
                    // fontColor:'#FFFFFF',
                }]
            },
            options: {
                responsive:false,
                // animation: false,
                scaleFontColor: '#FFFFFF',
                spanGaps:true,
                scales:{
                    x:{
                        grid: {
                            color:'#444444',
                        }
                    },
                    y:{
                        grid: {
                            color:'#444444',
                        }
                    }
                },
                plugins:{
                    legend:{
                        display:false,
                    }
                }
            }
            });

            return chart;
        }

        Chart.defaults.color = 'white';

        function createMap(id){
            var map = L.map(id).setView([-7.761728519274012, 110.23037834124277], 14);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            var myIcon = L.divIcon({className: 'my-div-icon'});
            L.marker([-7.761728519274012, 110.23037834124277], {icon: myIcon}).addTo(map);

            var legend = L.control({position: 'bottomright'});

            legend.onAdd = function (map) {

                var div = L.DomUtil.create('div', 'info legend'),
                    //grades = [0, 10, 20, 50, 100, 200, 500, 1000],
                    grades = [0, 12, 25, 37, 50, 62, 75, 87], //pretty break untuk 8
                    labels = [],
                    from, to;

                for (var i = 0; i < grades.length; i++) {
                    from = grades[i];
                    to = grades[i + 1];

                    labels.push(
                        '<i style="background:' + '#FFFFFF' + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+'));
                }

                // div.innerHTML = '<h4 style="background-color:blue;">Legenda:</h4><br>'+labels.join('<br>');
                div.innerHTML = `<div class="rounded" id="uav_status" style="background-color: #2b2b2b; height: 15vh; width:8vw; padding-top: 1vh;">
                                    Altitude<br><span id="altitude_status">1</span>m<br>Latitude<br><span id="latitude_status">-7.767341</span>
                                    <br>Longitude<br><span id="longitude_status">110.226859</span></div>`;
                return div;
            };

            legend.addTo(map);

            var planeIcon = L.icon({
                iconUrl: '/images/plane.png',
                // shadowUrl: '/images/plane_s.png',

                iconSize:     [60, 60], // size of the icon
                // shadowSize:   [40, 40], // size of the shadow
                iconAnchor:   [30, 30], // point of the icon which will correspond to marker's location
                // shadowAnchor: [-2, 70],  // the same for the shadow
                // popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
            });

            const planeMarker = L.marker([-7.761728519274012, 110.23037834124277], {icon: planeIcon, rotationAngle:0}).addTo(map);

            const latlon = [-7.761728519274012, 110.23037834124277];

            var polylinePoints = [
                [latlon[0]+ 0.0001, latlon[1]+ 0.006],
                [latlon[0]+ 0.001, latlon[1]+ 0.005],
                [latlon[0]+ 0.002, latlon[1]+ 0.002],
                [latlon[0]+ 0.0024, latlon[1]+ 0.001],
                [latlon[0]+ 0.004, latlon[1]+ 0.001]
            ];            
            
            const polyline = L.polyline(polylinePoints).addTo(map);     
            return {map: map, planeMarker: planeMarker, planeTrack: polyline};
        }

        function updateSensorMonitorValue(id, value){
            const val = document.getElementById(id+'_value');
            val.innerText = value;
        }

        function onDashIconClick(){
            createContentLayout("dash");
            const airspeed_id = createStatusMonitor("monitor-container", {name : "Airspeed", value:"13.7 m/s"});
            const uav_speed_id = createStatusMonitor("monitor-container", {name : "UAV Speed", value:"5 m/s"});
            const temperature_id = createStatusMonitor("monitor-container", {name : "Temperature", value:"43 °C"});
            const thermal_camera = createStatusMonitorImage("monitor-container", {name: "Thermal Camera", value:"20 C"})
            // createStatusMonitor("monitor-container", {name : "Humidity", value:"30 %"});
            createSensorMonitor("sensor-monitors", "graph1");
            createSensorMonitor2("sensor-monitors", "graph2");
            const graph1 = createSensorGraph('graph1', 'sensor1');
            const graph2 = createSensorGraph2('graph2', 'sensor2');
            const plane = createMap("map");

             // Update graph
             let i = 0;

            var width = 400,
                height = 400,
                buffer = new Uint8ClampedArray(width * height * 4);
            
            function randomizeBuffer() {
                for(var y = 0; y < height; y++) {
                    for(var x = 0; x < width; x++) {
                        const ran = Math.floor(Math.random() * 200);
                        var pos = (y * width + x) * 4; // position in buffer based on x and y
                        buffer[pos  ] = 50 + ran;           // some R value [0, 255]
                        buffer[pos+1] = 150;           // some G value
                        buffer[pos+2] = 50 + ran;           // some B value
                        buffer[pos+3] = 255;           // set alpha channel
                    }
                }
            }
            
            function rad_to_deg(radians)
            {
                var pi = Math.PI;
                return radians * (180/pi);
            }

            setInterval(()=>{
                console.log("update");
                
                ///Thermal Camera/////////////////////////////////
                randomizeBuffer();
                const c_thermal_camera = document.getElementById(thermal_camera);
                const ctx_thermal_camera = c_thermal_camera.getContext("2d");
                ctx_thermal_camera.moveTo(0, 0);
                ctx_thermal_camera.lineTo(200, 100);
                ctx_thermal_camera.stroke();
                var idata = ctx_thermal_camera.createImageData(width, height);
                idata.data.set(buffer);
                ctx_thermal_camera.putImageData(idata, 0, 0);
                /////////////////////////////////////////////////
                
                ////Map Manipulation/////////////////////////////
                const ran = Math.floor(Math.random() * 100) * 0.1;
                const ran1 = Math.floor(Math.random() * 100) * 0.1;
                
                const last_latlon = plane.planeMarker.getLatLng();
                const lat = -7.761728519274012 + ran * 0.001;
                const lon = 110.23037834124277 + ran1 * 0.001;
                const latln = new L.LatLng(lat, lon);
                plane.planeMarker.setLatLng(latln);///
                const plane_angle = Math.atan2(latln.lng - last_latlon.lng, latln.lat - last_latlon.lat);
                plane.planeMarker.setRotationAngle(rad_to_deg(plane_angle));
                const altitude_status = document.getElementById("altitude_status");
                altitude_status.innerText= ran.toFixed(2);
                const latitude_status = document.getElementById("latitude_status");
                latitude_status.innerText= lat.toFixed(6);
                const longitude_status = document.getElementById("longitude_status");
                longitude_status.innerText= lon.toFixed(6);
                plane.planeTrack.addLatLng(latln);
                if(plane.planeTrack.getLatLngs().length > 5)
                {
                    const latl = plane.planeTrack.getLatLngs();
                    latl.shift();
                    plane.planeTrack.setLatLngs(latl);
                }
                plane.map.setView(latln);
                ///////////////////////////////////////////////////

                ////Update sensor monitor and graph data///////////////////////////////////
                i+=10;
                updateSensorMonitorValue(airspeed_id, (20.0 + ran).toFixed(1) + ' m/s');
                updateSensorMonitorValue(uav_speed_id, (2.5 + ran).toFixed(1) + ' m/s');
                updateSensorMonitorValue(temperature_id, (30.5 + ran).toFixed(1) + ' m/s');
                
                const graph1_val1_data = Math.random().toFixed(2);
                const graph1_val1 = document.getElementById('graph1_val1');
                graph1_val1.innerText = graph1_val1_data;
                
                if(graph1.data.labels.length > 20)
                {
                    graph1.data.labels.shift();
                    graph1.data.datasets[0].data.shift();
                    graph1.data.datasets[1].data.shift();
                    graph1.data.datasets[2].data.shift();
                }
                graph1.data.labels.push("12:00");
                graph1.data.datasets[0].data.push(graph1_val1_data);
                graph1.data.datasets[1].data.push(Math.random());
                graph1.data.datasets[2].data.push(Math.random());
                graph1.update();

                if(graph2.data.labels.length > 20)
                {
                    graph2.data.labels.shift();
                    graph2.data.datasets[0].data.shift();
                    graph2.data.datasets[1].data.shift();

                }
                graph2.data.labels.push("12:00");
                graph2.data.datasets[0].data.push(Math.random());
                graph2.data.datasets[1].data.push(Math.random());
                graph2.update();
                /////////////////////////////////////////////////////////////////

            }, 1000);
        }

        function onLocIconClick(){
            createContentLayout("loc");
            createMap("map-l");
            createStatusMonitor("monitor-container-1", {name : "Airspeed", value:"13.7 m/s"});
            createStatusMonitor("monitor-container-1", {name : "UAV Speed", value:"5 m/s"});
            // createStatusMonitor("monitor-container-1", {name : "UAV Speed", value:"5 m/s"});
            createStatusMonitor("monitor-container-2", {name : "Temperature", value:"62 °C"});
            createStatusMonitor("monitor-container-2", {name : "Humidity", value:"12 %"});
            // createStatusMonitor("monitor-container-2", {name : "Humidity", value:"30 %"});
        }

        onDashIconClick();
        // onLocIconClick()


        // var socket = io();
        // var is_open = false;
        // var current_query = '';

        // socket.on('update', (msg) => {
        //     console.log('update');
        //     console.log(msg);
        //     // if(current_query != ''){
        //     //     console.log('get data');
        //     //     socket.emit('query_data', {'id' : current_query});
        //     // }
        // }); // data in database updated
    </script>

</html>